<!---related-products-by-tag.liquid --->

{% if section.settings.show_related_products == true %}

	{% assign heading = section.settings.related_title %}
	{% assign same_vendor = false %}
	{% assign same_type = false %}

	{% comment %}
	  Looking for a relevant collection.
	{% endcomment %}

	{% if product.metafields.c_f['Related Products'] %}
		{% assign collection = collections[product.metafields.c_f['Related Products']] %}
	{% endif %}

	{% assign found_a_collection = false %}
	{% if collection and collection.all_products_count > 1 %}
		{% unless section.settings.exclusions contains collection.handle %}
			{% assign found_a_collection = true %}
		{% endunless %}
	{% endif %}
	{% unless found_a_collection %}
		<!-- loop num:{{ collections.size }}-->
		{% for c in collections %}
			<!-- looping, testing {{page.handle}}=={{c.handle}} -->
			{% assign current = page.handle | trim | handelize %}
			{% assign this = c.handle | trim | handelize %}
			{% if current == this %}
			<!-- passes -->
				{% unless exclusions contains c.handle %}
					{% assign found_a_collection = true %}
					{% assign collection = c %}
					<!-- assigned {{c.handle}} -->
					{% break %}
				{% endunless %}
			{% endif %}
		{% endfor %}
	{% endunless %}


	{% if found_a_collection %}
	<!-- found a collection {{collection.products_count}}-->

		{% capture related_items %}
			{% if collection.products_count > 0 %}
				{% for product in collection.products %}
					{% unless product.handle == current_product.handle %} <!-- handle passes -->
						{% unless same_vendor and current_product.vendor != product.vendor %} <!-- vendor passes -->
							{% unless same_type and current_product.type != product.type %} <!-- type passes  -->

									{% render 'product-item', product: product %}
									<!-- rendering -->
								
							{% endunless %}
						{% endunless %}
					{% endunless %}
				{% endfor %}
			{% endif %}
		{% endcapture %}

		{% assign related_items = related_items | trim %}

		{% unless related_items == blank %}

			<div class="product-recommendations" id="ProductSection-{{ section.id }}" data-section-id="{{ section.id }}" data-section-type="product" data-enable-history-state="true" data-product-id="{{ product.id }}" data-limit="8">
				<div class="auralreccos content-section gutter--on">
					{% unless heading == blank %}
					<h3 class="h1">{{ heading }}</h3>
			      	{% endunless %}
					<div class="collection collection--{{ settings.grid_style }} collection--slider mount-collection">
						{{ related_items }}
					</div>
			    </div>
			</div>

		{% endunless %}
	{% endif %}
{% endif %}

{% schema %}
{
  "name": "Related products",
  "class": "shopify-section-product-recommendations",
  "settings": [
    {
      "type": "checkbox",
      "id": "show_related_products",
      "label": "Show related products",
      "info": "Uses each history page's handle/slug to match a collection handle. If our history url is /pages/mcintosh, we'd expect to see the mcintosh collection recommended",
      "default": true
    },
    {
      "id": "exclusions",
      "type": "text",
      "label": "Exclude Collections",
      "default": "frontpage,all,types,brands"
    },
    {
      "id": "related_title",
      "type": "text",
      "label": "Section title",
      "default": "Available Products"
    }
  ]
}
{% endschema %}